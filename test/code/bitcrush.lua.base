
local this = {}
local ffi = require("ffi")
function this.ternary(cond,then_,else_) if cond then return then_ else return else_ end end
function this.eps()             return 1e-18; end
function this.pi()              return 3.1415926535897932384; end
function this.random()          return math.random(); end
function this.irandom()         return math.floor(math.random() * 4294967296); end
function this.clip(x,low,high)  return (this.ternary(x<low,low,this.ternary(x>high,high,x))); end
function this.real(x)           return x; end
function this.int(x)            local int_part,_ = math.modf(x) return int_part; end
function this.sin(x)            return math.sin(x); end
function this.cos(x)            return math.cos(x); end
function this.abs(x)            return math.abs(x); end
function this.exp(x)            return math.exp(x); end
function this.floor(x)          return math.floor(x); end
function this.tan(x)            return math.tan(x); end
function this.tanh(x)           return math.tanh(x); end
function this.sqrt(x)           return x; end
function this.set(a,i,v)        a[i+1]=v; end
function this.get(a,i)          return a[i+1]; end
function this.makeArray(size,v) local a = {}; for i=1,size do a[i]=v end return a; end
function this.wrap_array(a)     return a; end
local Bitcrush_factor_c0 = {24.7875,24.7874,24.7868,24.7854,24.7831,24.7796,24.7746,24.7679,24.7595,24.7490,24.7364,24.7215,24.7041,24.6842,24.6617,24.6365,24.6084,24.5774,24.5435,24.5066,24.4667,24.4237,24.3776,24.3284,24.2760,24.2205,24.1618,24.1001,24.0352,23.9672,23.8961,23.8219,23.7448,23.6646,23.5815,23.4954,23.4065,23.3147,23.2201,23.1228,23.0229,22.9203,22.8151,22.7074,22.5973,22.4847,22.3698,22.2527,22.1333,22.0119,21.8883,21.7627,21.6352,21.5057,21.3745,21.2415,21.1068,20.9705,20.8327,20.6933,20.5526,20.4104,20.2670,20.1223,19.9765,19.8296,19.6816,19.5326,19.3827,19.2320,19.0804,18.9281,18.7750,18.6214,18.4672,18.3124,18.1572,18.0015,17.8455,17.6892,17.5326,17.3757,17.2187,17.0616,16.9044,16.7472,16.5899,16.4327,16.2756,16.1187,15.9619,15.8053,15.6489,15.4929,15.3372,15.1818,15.0268,14.8722,14.7181,14.5644,14.4113,14.2587,14.1067,13.9553,13.8045,13.6543,13.5048,13.3560,13.2080,13.0606,12.9140,12.7682,12.6232,12.4791,12.3357,12.1932,12.0516,11.9109,11.7711,11.6321,11.4942,11.3571,11.2210,11.0859,10.9517,10.8185,10.6864,10.5552,10.4250};
local Bitcrush_factor_c1 = {(-74.3592),(-74.3193),(-74.2414),(-74.1273),(-73.9785),(-73.7969),(-73.5840),(-73.3414),(-73.0705),(-72.7729),(-72.4497),(-72.1026),(-71.7326),(-71.3411),(-70.9292),(-70.4981),(-70.0489),(-69.5827),(-69.1006),(-68.6034),(-68.0921),(-67.5678),(-67.0312),(-66.4832),(-65.9246),(-65.3562),(-64.7788),(-64.1931),(-63.5997),(-62.9994),(-62.3927),(-61.7804),(-61.1630),(-60.5410),(-59.9150),(-59.2855),(-58.6530),(-58.0180),(-57.3810),(-56.7423),(-56.1025),(-55.4618),(-54.8207),(-54.1796),(-53.5387),(-52.8985),(-52.2592),(-51.6211),(-50.9845),(-50.3498),(-49.7170),(-49.0866),(-48.4587),(-47.8336),(-47.2114),(-46.5924),(-45.9767),(-45.3645),(-44.7560),(-44.1514),(-43.5508),(-42.9543),(-42.3621),(-41.7742),(-41.1909),(-40.6122),(-40.0381),(-39.4689),(-38.9046),(-38.3452),(-37.7909),(-37.2417),(-36.6976),(-36.1588),(-35.6252),(-35.0970),(-34.5741),(-34.0566),(-33.5445),(-33.0379),(-32.5367),(-32.0411),(-31.5509),(-31.0663),(-30.5871),(-30.1135),(-29.6455),(-29.1829),(-28.7259),(-28.2744),(-27.8284),(-27.3879),(-26.9529),(-26.5233),(-26.0991),(-25.6804),(-25.2671),(-24.8591),(-24.4565),(-24.0592),(-23.6672),(-23.2804),(-22.8989),(-22.5225),(-22.1513),(-21.7852),(-21.4242),(-21.0682),(-20.7172),(-20.3711),(-20.0300),(-19.6938),(-19.3623),(-19.0357),(-18.7138),(-18.3966),(-18.0841),(-17.7762),(-17.4728),(-17.1739),(-16.8795),(-16.5896),(-16.3040),(-16.0227),(-15.7458),(-15.4730),(-15.2045),(-14.9401),(-14.6797)};
local Bitcrush_factor_c2 = {110.2456,107.6917,105.1971,102.7602,100.3797,98.0545,95.7830,93.5642,91.3968,89.2796,87.2114,85.1912,83.2177,81.2900,79.4069,77.5675,75.7706,74.0154,72.3008,70.6260,68.9899,67.3918,65.8306,64.3057,62.8160,61.3609,59.9395,58.5510,57.1947,55.8697,54.5755,53.3113,52.0763,50.8700,49.6916,48.5405,47.4160,46.3176,45.2447,44.1966,43.1728,42.1727,41.1958,40.2415,39.3093,38.3987,37.5092,36.6403,35.7915,34.9624,34.1525,33.3613,32.5885,31.8336,31.0962,30.3759,29.6722,28.9848,28.3134,27.6575,27.0168,26.3910,25.7797,25.1825,24.5991,24.0293,23.4726,22.9289,22.3977,21.8789,21.3721,20.8770,20.3934,19.9210,19.4595,19.0087,18.5684,18.1382,17.7181,17.3076,16.9067,16.5151,16.1325,15.7588,15.3937,15.0371,14.6888,14.3485,14.0162,13.6915,13.3743,13.0645,12.7619,12.4662,12.1774,11.8954,11.6198,11.3506,11.0877,10.8308,10.5799,10.3349,10.0955,9.8616,9.6332,9.4100,9.1920,8.9791,8.7711,8.5679,8.3694,8.1755,7.9862,7.8012,7.6205,7.4439,7.2715,7.1030,6.9385,6.7778,6.6208,6.4674,6.3176,6.1712,6.0283,5.8886,5.7522,5.6190,5.4888};
function this.Bitcrush_factor(cv)
   local index = this.clip(this.int((127.0000 * cv)),0,127);
   return (Bitcrush_factor_c0[index+1] + (cv * (Bitcrush_factor_c1[index+1] + (Bitcrush_factor_c2[index+1] * cv))));

end

function this.Bitcrush_process(_ctx,i,cv)
   local out = i;
   if (cv == 0.0000) then
      out = i;

   else

      local b = 0.0;
      b = this.Bitcrush_factor(cv);
      local x = 0;
      x = this.int((i * b));
      out = (this.real(x) / b);

   end
   return out;

end

function this.Bitcrush_noteOn(_ctx,note,velocity,channel)

end

function this.Bitcrush_noteOff(_ctx,note,channel)

end

function this.Bitcrush_controlChange(_ctx,control,value,channel)

end

function this.Bitcrush_default(_ctx)

end


function this.process(i,cv) return this.Bitcrush_process(i,cv) end
function this.noteOn(note,velocity,channel) return this.Bitcrush_noteOn(note,velocity,channel) end
function this.noteOff(note,channel) return this.Bitcrush_noteOff(note,channel) end
function this.controlChange(control,value,channel) return this.Bitcrush_controlChange(control,value,channel) end
function this.init() return this.Bitcrush_process_init() end
function this.default(ctx) return this.Bitcrush_default(ctx) end
this.config = { inputs = 2, outputs = 1, noteon_inputs = 3, noteoff_inputs = 2, controlchange_inputs = 3, is_active = false }
return this
